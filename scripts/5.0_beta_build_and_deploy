#!/bin/bash
set -euo pipefail

echo Overwriting upstream install.rdf for Mac, Windows, and LibreOffice plugins
cp install-Mac.rdf modules/zotero-word-for-mac-integration/install.rdf
cp install-LO.rdf modules/zotero-libreoffice-integration/install.rdf
cp install-Windows.rdf modules/zotero-word-for-windows-integration/install.rdf

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
. "$ROOT_DIR/config.sh"

CHANNEL="beta"
export SAFARI_APPEX="$ROOT_DIR/../safari-app-extension-builds/beta/ZoteroSafariExtension.appex"

cd "$SCRIPT_DIR"

./check_requirements_packaging continue

hash=`./get_repo_branch_hash jurism-6.0.20`
source_dir=`./get_commit_files $hash`

function cleanup {
	rm -rf $source_dir
}
trap cleanup EXIT

"$ZOTERO_BUILD_DIR/xpi/build_xpi" -s "$source_dir" -c $CHANNEL -m $hash
./build_and_deploy -d "$ZOTERO_BUILD_DIR/xpi/build/staging" -p $BUILD_PLATFORMS -c $CHANNEL

echo Restoring upstream install.rdf for Mac, Windows, and LibreOffice plugins
cd "$ROOT_DIR/modules/zotero-word-for-mac-integration"
git checkout install.rdf
cd "$ROOT_DIR/modules/zotero-word-for-windows-integration"
git checkout install.rdf
cd "$ROOT_DIR/modules/zotero-libreoffice-integration"
git checkout install.rdf
cd "$ROOT_DIR"
